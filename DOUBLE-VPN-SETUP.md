# Настройка гибридного VPN (обычные + двойные подключения)

## Описание

Создана гибридная конфигурация, которая поддерживает:
1. **Обычные подключения** - клиенты подключаются напрямую к серверу
2. **Двойные подключения** - цепочка серверов для дополнительной безопасности

### Схемы подключений:

**Обычное подключение:**
```
Клиент -> Server1 (Reality:443) -> Интернет
```

**Двойное подключение (цепочка):**
```
Клиент -> Server2 (Reality:8443) -> Server1 (Reality:8443) -> Интернет
```

## Файлы конфигурации

### Server1 (основной сервер - гибридный)
- `xray/config_hybrid.json` - гибридная конфигурация (обычные + серверные подключения)
- `docker-compose.yml` - запуск первого сервера

### Server2 (промежуточный сервер)
- `xray/config_server2.json` - конфигурация второго сервера с цепочкой
- `docker-compose-server2.yml` - запуск второго сервера

## Настройка

### 1. Настройка Server1 (гибридный)
Server1 работает в гибридном режиме:
- **Порт 443** - для обычных клиентов
- **Порт 8443** - для подключения от других серверов (цепочка)

### 2. Настройка Server2
1. **Замените `SERVER1_IP_OR_DOMAIN`** в файле `config_server2.json` на реальный IP или домен первого сервера
2. Запустите второй сервер:
   ```bash
   docker-compose -f docker-compose-server2.yml up -d
   ```

### 3. Порты
- **Server1**: 80, 443 (обычные клиенты), 8443 (серверные подключения)
- **Server2**: 8443 (клиенты для цепочки)

## Принцип работы

### Обычное подключение:
1. Клиент подключается к Server1 через Reality на порт 443
2. Server1 обрабатывает трафик и отправляет в интернет

### Двойное подключение (цепочка):
1. Клиент подключается к Server2 через Reality на порт 8443
2. Server2 принимает трафик и перенаправляет его на Server1 через Reality на порт 8443
3. Server1 обрабатывает трафик и отправляет в интернет
4. Ответ идет обратно по той же цепочке

## Безопасность

- Оба сервера используют одинаковые ключи Reality для совместимости
- Можно использовать разные ключи, но тогда нужно обновить конфигурацию
- Рекомендуется использовать разные UUID для клиентов на каждом сервере

## Мониторинг

- Server1 API: порт 10085
- Server2 API: порт 10086
- Логи: `./logs/xray/`
